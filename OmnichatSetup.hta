<html>
<head>
  <title>Omnichat Setup</title>
  <HTA:APPLICATION ID="OmnichatSetup" APPLICATIONNAME="Omnichat Setup" BORDER="thin" BORDERSTYLE="normal" CAPTION="yes" SHOWINTASKBAR="yes" SINGLEINSTANCE="yes" SYSMENU="yes" SCROLL="no" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; background: #0b1220; color: #f5f6fa; }
    header { background: #1f2a44; padding: 16px 24px; }
    h1 { margin: 0; font-size: 20px; }
    main { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
    button { background: #4c8dff; border: none; color: #fff; font-size: 16px; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 200px; }
    button[disabled] { background: #3a4a6a; cursor: default; }
    .status { font-weight: 600; }
    textarea { width: 100%; height: 200px; background: #121b2e; border: 1px solid #2f3b59; color: #d7def0; padding: 12px; resize: none; }
    footer { padding: 16px 24px; background: #101827; font-size: 12px; color: #8ea0c7; }
  </style>
  <script language="VBScript">
    Option Explicit
    Dim shell, fso, shellApp, installRoot, scriptFolder, electronVersion, electronUrl, lastErrorMessage

    Sub Window_OnLoad()
      Set shell = CreateObject("WScript.Shell")
      Set fso = CreateObject("Scripting.FileSystemObject")
      Set shellApp = CreateObject("Shell.Application")
      scriptFolder = GetScriptFolder()
      installRoot = shell.ExpandEnvironmentStrings("%LocalAppData%") & "\Omnichat"
      electronVersion = "28.2.0"
      electronUrl = "https://github.com/electron/electron/releases/download/v" & electronVersion & "/electron-v" & electronVersion & "-win32-x64.zip"
      UpdateStatus "Ready to install"
      AppendLog "Omnichat will be installed to " & installRoot
    End Sub

    Function GetScriptFolder()
      Dim path
      path = window.location.pathname
      If Left(path, 1) = "/" Then path = Mid(path, 2)
      path = Replace(path, "%20", " ")
      path = Replace(path, "/", "\")
      GetScriptFolder = Left(path, InStrRev(path, "\"))
    End Function

    Sub InstallBtn_OnClick()
      InstallBtn.disabled = True
      If InstallOmnichat() Then
        UpdateStatus "Installation complete"
        AppendLog "Launching Omnichat..."
        shell.Run """" & installRoot & "\Omnichat.exe" & """", 1, False
        MsgBox "Omnichat is ready to use! A desktop shortcut has been created.", vbInformation, "Omnichat Setup"
        window.close
      Else
        UpdateStatus "Installation failed"
        MsgBox "Omnichat installation failed: " & lastErrorMessage, vbCritical, "Omnichat Setup"
        InstallBtn.disabled = False
      End If
    End Sub

    Function InstallOmnichat()
      On Error Resume Next
      lastErrorMessage = ""
      InstallOmnichat = False
      Dim appSource, electronZip, targetApp
      appSource = scriptFolder & "app"
      If Not fso.FolderExists(appSource) Then
        Fail "Missing app folder next to OmnichatSetup.hta"
        InstallOmnichat = False
        Exit Function
      End If

      AppendLog "Closing running copies..."
      shell.Run "taskkill /IM Omnichat.exe /F", 0, False
      SleepMs 1000

      If fso.FolderExists(installRoot) Then
        AppendLog "Removing previous installation..."
        DeleteFolder installRoot
        If Failed() Then
          InstallOmnichat = False
          Exit Function
        End If
      End If
      CreateFolder installRoot
      If Failed() Then
        InstallOmnichat = False
        Exit Function
      End If

      electronZip = shell.ExpandEnvironmentStrings("%TEMP%") & "\electron.zip"
      AppendLog "Downloading Electron runtime..."
      UpdateStatus "Downloading runtime"
      DownloadFile electronUrl, electronZip
      If Failed() Then
        InstallOmnichat = False
        Exit Function
      End If

      AppendLog "Extracting runtime..."
      UpdateStatus "Extracting runtime"
      ExtractZip electronZip, installRoot
      If Failed() Then
        InstallOmnichat = False
        Exit Function
      End If
      If fso.FileExists(electronZip) Then fso.DeleteFile electronZip, True

      If fso.FileExists(installRoot & "\electron.exe") Then
        fso.MoveFile installRoot & "\electron.exe", installRoot & "\Omnichat.exe"
        If Failed() Then
          InstallOmnichat = False
          Exit Function
        End If
      End If

      If fso.FileExists(installRoot & "\resources\default_app.asar") Then
        fso.DeleteFile installRoot & "\resources\default_app.asar", True
        If Failed() Then
          InstallOmnichat = False
          Exit Function
        End If
      End If

      targetApp = installRoot & "\resources\app"
      If fso.FolderExists(targetApp) Then
        DeleteFolder targetApp
        If Failed() Then
          InstallOmnichat = False
          Exit Function
        End If
      End If
      CreateFolder targetApp
      If Failed() Then
        InstallOmnichat = False
        Exit Function
      End If

      AppendLog "Copying Omnichat files..."
      fso.CopyFolder appSource & "\*", targetApp, True
      If Failed() Then
        InstallOmnichat = False
        Exit Function
      End If

      AppendLog "Creating desktop shortcut..."
      CreateShortcut installRoot & "\Omnichat.exe"
      If Failed() Then
        InstallOmnichat = False
        Exit Function
      End If

      InstallOmnichat = True
    End Function

    Sub UpdateStatus(message)
      StatusLabel.innerText = message
    End Sub

    Sub AppendLog(message)
      Dim current
      current = LogBox.value
      If Len(current) > 0 Then current = current & vbCrLf
      LogBox.value = current & FormatDateTime(Now, vbLongTime) & " - " & message
      LogBox.scrollTop = LogBox.scrollHeight
    End Sub

    Sub DownloadFile(url, destination)
      Dim http, stream
      Set http = CreateObject("MSXML2.XMLHTTP")
      http.open "GET", url, False
      http.send
      If http.status <> 200 Then
        Fail "Unable to download runtime (" & http.status & ")"
        Exit Sub
      End If

      Set stream = CreateObject("ADODB.Stream")
      stream.Type = 1
      stream.Open
      stream.Write http.responseBody
      stream.SaveToFile destination, 2
      stream.Close
      FailIfNeeded
    End Sub

    Sub ExtractZip(zipPath, destination)
      Dim zipFolder
      If Not fso.FolderExists(destination) Then CreateFolder destination
      Set zipFolder = shellApp.NameSpace(zipPath)
      If zipFolder Is Nothing Then
        Fail "Unable to open runtime archive"
        Exit Sub
      End If
      shellApp.NameSpace(destination).CopyHere zipFolder.Items, 16
      WaitForFile destination & "\electron.exe", 600
      FailIfNeeded
    End Sub

    Sub WaitForFile(filePath, timeoutSeconds)
      Dim elapsed
      elapsed = 0
      Do While (Not fso.FileExists(filePath)) And elapsed < timeoutSeconds
        SleepMs 500
        elapsed = elapsed + 0.5
      Loop
      If Not fso.FileExists(filePath) Then
        Fail "Timed out waiting for runtime extraction"
      End If
    End Sub

    Sub DeleteFolder(path)
      On Error Resume Next
      fso.DeleteFolder path, True
      FailIfNeeded
      On Error GoTo 0
    End Sub

    Sub CreateFolder(path)
      If Not fso.FolderExists(path) Then
        fso.CreateFolder path
        FailIfNeeded
      End If
    End Sub

    Sub CreateShortcut(target)
      Dim desktop, shortcutPath, shortcut
      desktop = shell.SpecialFolders("Desktop")
      shortcutPath = desktop & "\Omnichat.lnk"
      Set shortcut = shell.CreateShortcut(shortcutPath)
      shortcut.TargetPath = target
      shortcut.WorkingDirectory = installRoot
      shortcut.IconLocation = target & ",0"
      shortcut.Save
      FailIfNeeded
    End Sub

    Sub Fail(message)
      lastErrorMessage = message
      AppendLog "Error: " & message
    End Sub

    Sub FailIfNeeded()
      If Err.Number <> 0 Then
        lastErrorMessage = Err.Description
        AppendLog "Error: " & lastErrorMessage
      End If
      Err.Clear
    End Sub

    Function Failed()
      Failed = (lastErrorMessage <> "")
    End Function

    Sub SleepMs(ms)
      Dim command
      command = "powershell -NoProfile -Command Start-Sleep -Milliseconds " & CStr(ms)
      shell.Run command, 0, True
    End Sub
  </script>
</head>
<body>
  <header>
    <h1>Omnichat Installer</h1>
    <div class="status" id="StatusLabel">Loading...</div>
  </header>
  <main>
    <div>
      Click Install to set up Omnichat in just a moment. We'll handle everything automatically.
    </div>
    <button id="InstallBtn">Install</button>
    <textarea id="LogBox" readonly></textarea>
  </main>
  <footer>
    A desktop shortcut will be placed once installation completes.
  </footer>
</body>
</html>
